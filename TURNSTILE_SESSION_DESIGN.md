# Turnstileセッション管理の設計

## 実装方法の比較

### 1. クッキーベース（推奨）

#### メリット
- 実装がシンプル
- DB負荷なし
- ユーザーごとに独立して管理
- スケーラブル（サーバー間で状態共有不要）

#### デメリット
- クッキー削除で無効化される
- ブラウザごとに個別管理
- クッキーを受け入れないユーザーには非対応

#### セキュリティ対策
- HMAC署名で改ざん防止
- HTTPOnly属性でXSS対策
- Secure属性でHTTPS通信限定
- 有効期限を設定

#### 実装の複雑度
★☆☆☆☆ (低)

---

### 2. DBベース

#### メリット
- クッキー削除されても有効
- 統計情報の収集が容易
- IPアドレスベースで管理可能
- 集中管理による柔軟な制御

#### デメリット
- DB負荷が増加
- 実装が複雑
- スケーリング時に考慮が必要
- 定期的なクリーンアップが必要

#### セキュリティ対策
- IP + User-Agentのハッシュで識別
- タイムスタンプで有効期限管理
- アクセスカウントで異常検知

#### 実装の複雑度
★★★☆☆ (中)

---

### 3. メモリキャッシュ（Redis等）

#### メリット
- 高速
- DBより軽量
- TTL（有効期限）機能が標準装備
- スケーリングしやすい

#### デメリット
- 外部依存が増える
- サーバー再起動で消える
- 追加のインフラが必要

#### セキュリティ対策
- IPアドレスベースでキャッシュ
- TTLで自動期限切れ
- カウンターで回数制限

#### 実装の複雑度
★★☆☆☆ (中低) ※Redisが使用可能な場合

---

## 推奨アプローチ: ハイブリッド方式

### 基本戦略
1. **クッキー**を第一選択肢として使用
2. クッキーがない場合は**メモリベースの簡易キャッシュ**で補完
3. 必要に応じてDBに記録（統計目的）

### 設定パラメータ
```yaml
# ServerConfig.yml
TurnstileSessionDuration: 3600  # セッション有効期間（秒）
TurnstileSessionMaxUses: 10     # セッション内の最大利用回数
TurnstileUseSession: true       # セッション機能の有効/無効
```

### セキュリティレベル
- **低リスク**: セッション有効、長時間（1時間）、回数制限なし
- **中リスク**: セッション有効、短時間（15分）、10回まで
- **高リスク**: セッション無効、毎回検証

---

## 実装方針

### Phase 1: シンプルなクッキーベース実装
- 署名付きクッキーで検証済みセッションを管理
- 有効期限とアクセスカウントを含める
- HMAC-SHA256で署名

### Phase 2: メモリキャッシュの追加（オプション）
- sync.Mapでインメモリキャッシュ
- IP単位で検証状態を保持
- 定期的に期限切れエントリをクリーンアップ

### Phase 3: DB記録の追加（統計用・オプション）
- 検証成功時に記録
- アクセスログと連携
- 異常パターンの検出

---

## クッキー構造の詳細

### クッキー名
`turnstile_verified`

### クッキー値の構造
```
Base64(IP|Timestamp|Counter|HMAC)
```

### 構成要素
- **IP**: リクエスト元IPアドレス（バインディング用）
- **Timestamp**: 検証成功時刻（Unix timestamp）
- **Counter**: 使用回数
- **HMAC**: 上記の署名（改ざん防止）

### 検証フロー
```
1. クッキー存在確認
2. Base64デコード
3. HMAC検証（改ざんチェック）
4. IP一致確認（クッキーの横取り防止）
5. 有効期限確認
6. 使用回数確認
7. OK → 処理続行、NG → Turnstileチャレンジ
```

---

## セキュリティ考慮事項

### クッキーのセキュリティ
1. **HttpOnly**: JavaScriptからアクセス不可
2. **Secure**: HTTPS通信のみ
3. **SameSite=Strict**: CSRF対策
4. **署名**: 改ざん防止
5. **IPバインディング**: セッション横取り防止

### 攻撃シナリオと対策

#### シナリオ1: クッキーの横取り
- **対策**: IPアドレスとバインディング
- **効果**: 異なるIPからの使用を検出

#### シナリオ2: クッキーの偽造
- **対策**: HMAC署名
- **効果**: サーバーの秘密鍵がないと偽造不可

#### シナリオ3: リプレイ攻撃
- **対策**: タイムスタンプと回数制限
- **効果**: 古いクッキーや過度な使用を検出

#### シナリオ4: プロキシ経由の攻撃
- **対策**: User-Agentも含めた署名（オプション）
- **効果**: 同一IPでも異なるクライアントを識別

---

## パフォーマンスへの影響

### クッキーベース
- **検証オーバーヘッド**: 1ms未満（HMAC計算のみ）
- **メモリ使用**: ほぼゼロ
- **Cloudflare APIコール**: 大幅削減（初回のみ）

### DBベース
- **検証オーバーヘッド**: 5-10ms（DB読み取り）
- **メモリ使用**: DB接続プール
- **DB負荷**: SELECT/INSERT/UPDATE

### メモリキャッシュ
- **検証オーバーヘッド**: 1ms未満（マップ検索）
- **メモリ使用**: エントリ数 × 数百バイト
- **スケーリング**: ロック競合に注意

---

## 推奨設定例

### 一般的なWebサイト
```yaml
TurnstileUseSession: true
TurnstileSessionDuration: 3600   # 1時間
TurnstileSessionMaxUses: 0       # 無制限
```

### セキュリティ重視
```yaml
TurnstileUseSession: true
TurnstileSessionDuration: 900    # 15分
TurnstileSessionMaxUses: 10      # 10回まで
```

### 開発/テスト環境
```yaml
TurnstileUseSession: true
TurnstileSessionDuration: 86400  # 24時間
TurnstileSessionMaxUses: 0       # 無制限
```

### 最高セキュリティ
```yaml
TurnstileUseSession: false       # 毎回検証
```
